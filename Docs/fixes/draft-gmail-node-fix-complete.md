# Draft Gmail Node Fix - Complete Solution

## Problem Identified

The Draft Gmail node has TWO issues:

### Issue #1: Missing Recipient Email
- **Current**: No `to` field configured
- **Root Cause**: For Gmail draft creation, the recipient email must be specified in `options.sendTo`, not as a top-level parameter
- **Impact**: Gmail drafts are created with empty "To:" field

### Issue #2: Wrong Email Body
- **Current**: `message` field uses `emailSubject` instead of `emailBody`
- **Root Cause**: Copy-paste error in the expression
- **Impact**: Email body only shows the subject line, not the full email content

---

## Solution

### Corrected Draft Gmail Node Configuration

```json
{
  "parameters": {
    "resource": "draft",
    "subject": "={{ JSON.parse($json.content.parts[0].text)[0].emailSubject }}",
    "message": "={{ JSON.parse($json.content.parts[0].text)[0].emailBody }}",
    "options": {
      "sendTo": "={{ $('Outreach Input Processing').item.json.contact.email }}"
    }
  },
  "type": "n8n-nodes-base.gmail",
  "typeVersion": 2.1,
  "position": [-544, -384],
  "id": "ce9f62db-a8f5-42ae-b169-27922f6b065c",
  "name": "Draft Gmail",
  "webhookId": "7a97ea05-8017-420d-b85c-fadc1dc6a8dc",
  "credentials": {
    "gmailOAuth2": {
      "id": "rEDqr1LkX2ZgxHLO",
      "name": "Gmail account"
    }
  }
}
```

---

## Changes Made

### Change #1: Fixed Message Field
**Before**:
```json
"message": "={{ JSON.parse($json.content.parts[0].text)[0].emailSubject }}"
```

**After**:
```json
"message": "={{ JSON.parse($json.content.parts[0].text)[0].emailBody }}"
```

### Change #2: Added Recipient Email
**Before**:
```json
"options": {}
```

**After**:
```json
"options": {
  "sendTo": "={{ $('Outreach Input Processing').item.json.contact.email }}"
}
```

---

## Why This Works

### Gmail Node Draft Creation Structure
According to the N8N Gmail node documentation and schema:

1. **Required Parameters**:
   - `subject`: The email subject line
   - `message`: The email body content
   - `emailType`: "text" or "html" (defaults to "text")

2. **Optional Parameters** (in `options`):
   - `sendTo`: The recipient email address(es)
   - `ccList`: CC recipients
   - `bccList`: BCC recipients
   - `attachmentsUi`: File attachments
   - `replyTo`: Reply-to address
   - `threadId`: Thread ID for replies

**Key Insight**: Unlike the "Send Message" operation which has `sendTo` as a required top-level parameter, the "Create Draft" operation places `sendTo` in the `options` object.

---

## Data Flow Verification

### Available Data at Draft Gmail Node

From the execution data (ID: 3864), we confirmed:

1. **Recipient Email**: Available at `$('Outreach Input Processing').item.json.contact.email`
   - Value: `"markus.fischer@tharpventures.com"`

2. **Email Subject**: Available at `JSON.parse($('AI Email Generation').item.json.content.parts[0].text)[0].emailSubject`
   - Value: `"Application for Ecommerce Copywriter - Ivo Dachev"`

3. **Email Body**: Available at `JSON.parse($('AI Email Generation').item.json.content.parts[0].text)[0].emailBody`
   - Value: Complete personalized email content (confirmed in execution data)

---

## Implementation Method

Since the N8N MCP partial update tool is failing, use the N8N UI to manually update the node:

### Step 1: Open the Workflow in N8N UI
1. Navigate to N8N → Workflows
2. Open: "LinkedIn-SEO-Gmail-sub-flow-Workshop-OutreachTracking--Augment"
3. Find the "Draft Gmail" node

### Step 2: Update the Message Field
1. Click on the "Draft Gmail" node
2. Find the "Message" field
3. Change from:
   ```
   {{ JSON.parse($json.content.parts[0].text)[0].emailSubject }}
   ```
4. To:
   ```
   {{ JSON.parse($json.content.parts[0].text)[0].emailBody }}
   ```

### Step 3: Add Recipient Email
1. In the same "Draft Gmail" node
2. Expand the "Options" section
3. Find "To Email" field
4. Set to:
   ```
   {{ $('Outreach Input Processing').item.json.contact.email }}
   ```

### Step 4: Save and Test
1. Click "Save" in the workflow editor
2. Execute the workflow again
3. Verify the Gmail draft has:
   - ✅ Recipient email in "To:" field
   - ✅ Full email body content

---

## Expected Results After Fix

### Gmail Draft Should Contain:

**To**: `markus.fischer@tharpventures.com`

**Subject**: `Application for Ecommerce Copywriter - Ivo Dachev`

**Body**: 
```
Dear Hiring Manager,

I am writing to express my strong interest in the Ecommerce Copywriter position at [Company Name]. With my proven track record in creating compelling copy that drives conversions and my deep understanding of e-commerce best practices, I am confident I can make a significant contribution to your team.

[Full personalized email content generated by AI...]

Best regards,
Ivo Dachev
[Contact Information]
```

---

## Troubleshooting

### If Recipient Email Is Still Empty:
1. Verify the Outreach Input Processing node is executing successfully
2. Check that `contact.email` field exists in the output
3. Confirm the expression syntax is correct (no typos)

### If Email Body Is Still Wrong:
1. Verify the AI Email Generation node is producing valid JSON
2. Check that the JSON structure includes `emailBody` field
3. Test the expression in the N8N expression editor

### If Both Issues Persist:
1. Check the node connections in the workflow
2. Verify the data is flowing correctly through the Merge node
3. Review the execution data for the Draft Gmail node input

---

## Alternative: Use N8N API to Update

If manual UI update is not preferred, you can use the N8N API directly:

```bash
curl -X PATCH "http://your-n8n-instance/api/v1/workflows/Vp9DpKF3xT2ysHhx" \
  -H "X-N8N-API-KEY: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "nodes": [
      {
        "id": "ce9f62db-a8f5-42ae-b169-27922f6b065c",
        "parameters": {
          "resource": "draft",
          "subject": "={{ JSON.parse($json.content.parts[0].text)[0].emailSubject }}",
          "message": "={{ JSON.parse($json.content.parts[0].text)[0].emailBody }}",
          "options": {
            "sendTo": "={{ $('"'"'Outreach Input Processing'"'"').item.json.contact.email }}"
          }
        }
      }
    ]
  }'
```

---

## Summary

**Root Causes**:
1. Gmail draft creation requires `sendTo` in `options`, not as top-level parameter
2. Copy-paste error caused `message` to use `emailSubject` instead of `emailBody`

**Fixes Applied**:
1. Added `options.sendTo` with expression to get recipient email
2. Changed `message` field to use `emailBody` instead of `emailSubject`

**Expected Outcome**:
- ✅ Gmail drafts will have recipient email in "To:" field
- ✅ Gmail drafts will have full email body content
- ✅ No more missing information in drafts

**Next Steps**:
1. Apply the fix using N8N UI (recommended) or API
2. Test the workflow with a new execution
3. Verify the Gmail draft is created correctly
4. If "John Doe" placeholder issue persists, investigate Contact Tracking workflow

