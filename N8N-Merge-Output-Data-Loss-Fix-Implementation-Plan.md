# N8N Merge Output Data Loss – Implementation Plan

> Generated by: Claude Sonnet 4
>
> Created: 2025-09-12
>
> Target workflow: https://n8n.srv972609.hstgr.cloud/workflow/qRciPpY0DlFJyI8i ("Linkedin- SEO - Gmail Outreach - fix1")

---

## Executive Summary
The workflow’s “Merge – Outreach” node currently combines four incoming streams by position. When one stream has fewer items, the merge output shrinks to the smallest count (e.g., 4 inputs with 27 items → only 3 outputs), and items can lose key fields because index-based alignment mixes unrelated records. As a result, the Google Sheets “Tracking” tab only receives Timestamp and Status, while Company, Job Title, Job URL, Email, and DedupeKey remain empty.

Solution: Replace position-based merging with semantic joining (Plan B). Compute stable join keys and chain two merges by matching fields so each item reaching “Build Tracking Fields” contains all required data at the top level. Preserve resume generation (“POST to GDocs”) and email flows.

---

## Root Cause Analysis
- The “Merge – Outreach” node is configured for Combine by Position with four inputs of different semantics: jobs, Google Docs HTTP response, Apollo contacts, and verified emails.
- Position-based combine aligns by index, not meaning. If any input has fewer items, the total output equals that smallest count, dropping items.
- Additionally, the Google Docs POST response does not carry job/company/email fields expected by downstream logic; when its item aligns into the merged output, it pollutes or overwrites top-level fields, causing blanks in Company, Job Title, Job URL, Email, and DedupeKey for the “Build Tracking Fields” node.
- Therefore, the Tracking sheet only receives Timestamp and Status: the other fields are not present on the item entering the precheck branch.

---

## Complete Implementation Guide (Plan B: Semantic Joining)

### Overview of changes
- Add two Set nodes to compute join keys:
  1) Set Keys – Jobs (after Limit Matched Resumes – 313)
  2) Set Keys – Contacts (after Run an Actor and get dataset)
- Add chained merges configured as Matching Fields:
  - Merge A: Jobs ↔ Contacts by domain, enrich Jobs
  - Merge B: (Merge A) ↔ Verified Email ONLY by email, enrich the merged item
- Rewire the precheck branch to originate from Merge B instead of Merge – Outreach.
- Update “Build Tracking Fields” assignments to robust fallbacks.
- Keep the POST to GDocs → Merge – Outreach connection to preserve resume generation.

### Step 1: Add Set Keys – Jobs (after “Limit Matched Resumes – 313”)
- Node name: Set Keys – Jobs
- Placement: Immediately after “Limit Matched Resumes – 313”
- Mode: Keep Only Set = false (add fields without removing existing)
- New fields and expressions:

```n8n
companyDomain = {{ ($json.companyWebsite || '').toString()
  .replace(/^(https?:\/\/)?(www\.)?/,'')
  .split('/')[0]
  .toLowerCase()
  .trim() }}

dedupeKey = {{ ((($json.companyName||$json.company||'')+'').toLowerCase().trim())
  + '|' +
  ((($json.title||$json.jobTitle||'')+'').toLowerCase().trim()) }}
```

### Step 2: Add Set Keys – Contacts (after “Run an Actor and get dataset”)
- Node name: Set Keys – Contacts
- Placement: Immediately after “Run an Actor and get dataset”
- Mode: Keep Only Set = false
- New fields and expressions:

```n8n
contactCompanyDomain = {{ ($json.organization_primary_domain
  || $json.organization?.primary_domain
  || $json.organization_website_url
  || '').toString()
  .replace(/^(https?:\/\/)?(www\.)?/,'')
  .split('/')[0]
  .toLowerCase()
  .trim() }}

email = {{ ($json.email || '').toString().toLowerCase().trim() }}
```

### Step 3: Create Merge A – Jobs + Contacts
- Node name: Merge A – Jobs + Contacts
- Mode: Combine
- Combine By: Matching Fields
- Fields to Match:
  - Input 1 field: companyDomain
  - Input 2 field: contactCompanyDomain
- Output Data: Enrich Input 1 (Jobs remain the base)
- Multiple Matches: First Match (recommended; can switch to Include All Matches later if needed)
- Connections:
  - Input 1: Set Keys – Jobs
  - Input 2: Set Keys – Contacts

### Step 4: Create Merge B – Enrich with Verified Email
- Node name: Merge B – Enrich with Verified Email
- Mode: Combine
- Combine By: Matching Fields
- Fields to Match:
  - Input 1 field: email
  - Input 2 field: email
- Output Data: Enrich Input 1
- Multiple Matches: First Match
- Connections:
  - Input 1: Merge A – Jobs + Contacts
  - Input 2: Verified Email ONLY

### Step 5: Rewire the precheck branch
- Disconnect: Merge – Outreach → Loop Over Items
- Connect: Merge B – Enrich with Verified Email → Loop Over Items
- Do not remove: POST to GDocs → Merge – Outreach (keep intact to preserve resume generation)

### Step 6: Update “Build Tracking Fields” assignments (robust fallbacks)
Set the following assignments in the Set node (or Function/Code if used) named “Build Tracking Fields”:

```n8n
timeStamp = {{ $now }}

companyName = {{ $json.companyName
  || $json.company
  || $json.organization_name
  || $json.organization?.name
  || $json.employment_history?.[0]?.organization_name
  || '' }}

jobTitle = {{ $json.title || $json.jobTitle || '' }}

jobUrl = {{ $json.link || $json.jobUrl || $json.url || '' }}

recepientEmail = {{ $json.email || '' }}

dedupeKey = {{ ((($json.companyName
  || $json.company
  || $json.organization_name
  || $json.organization?.name
  || $json.employment_history?.[0]?.organization_name
  || '')+'').toLowerCase().trim())
  + '|' +
  ((($json.title||$json.jobTitle||'')+'').toLowerCase().trim()) }}

status = precheck
```

### Step 7: Google Sheets “Email Tracking – Upsert (precheck)” mapping
- Sheet/Tab: Tracking
- Operation: Upsert/Append (existing configuration)
- Value Input Mode: Define
- Column Mapping:
  - Timestamp ← timeStamp
  - Company ← companyName
  - Job Title ← jobTitle
  - Job URL ← jobUrl
  - Email ← recepientEmail
  - Status ← status
  - DedupeKey ← dedupeKey
- Upsert / Match Column: DedupeKey

---

## Technical Specifications

### Node settings and expressions (copy-ready)

1) Set Keys – Jobs
- Keep Only Set: false
- Add fields:
```n8n
companyDomain = {{ ($json.companyWebsite || '').toString()
  .replace(/^(https?:\/\/)?(www\.)?/,'')
  .split('/')[0]
  .toLowerCase()
  .trim() }}

dedupeKey = {{ ((($json.companyName||$json.company||'')+'').toLowerCase().trim())
  + '|' +
  ((($json.title||$json.jobTitle||'')+'').toLowerCase().trim()) }}
```

2) Set Keys – Contacts
- Keep Only Set: false
- Add fields:
```n8n
contactCompanyDomain = {{ ($json.organization_primary_domain
  || $json.organization?.primary_domain
  || $json.organization_website_url
  || '').toString()
  .replace(/^(https?:\/\/)?(www\.)?/,'')
  .split('/')[0]
  .toLowerCase()
  .trim() }}

email = {{ ($json.email || '').toString().toLowerCase().trim() }}
```

3) Merge A – Jobs + Contacts
- Mode: Combine → Matching Fields
- Match: companyDomain (Input 1) = contactCompanyDomain (Input 2)
- Output Data: Enrich Input 1
- Multiple Matches: First Match

4) Merge B – Enrich with Verified Email
- Mode: Combine → Matching Fields
- Match: email (Input 1) = email (Input 2)
- Output Data: Enrich Input 1
- Multiple Matches: First Match

5) Build Tracking Fields assignments
```n8n
timeStamp = {{ $now }}
companyName = {{ $json.companyName || $json.company || $json.organization_name || $json.organization?.name || $json.employment_history?.[0]?.organization_name || '' }}
jobTitle = {{ $json.title || $json.jobTitle || '' }}
jobUrl = {{ $json.link || $json.jobUrl || $json.url || '' }}
recepientEmail = {{ $json.email || '' }}
dedupeKey = {{ ((($json.companyName||$json.company||$json.organization_name||$json.organization?.name||$json.employment_history?.[0]?.organization_name||'')+'').toLowerCase().trim()) + '|' + ((($json.title||$json.jobTitle||'')+'').toLowerCase().trim()) }}
status = precheck
```

### Connection rewiring
- Remove: Merge – Outreach → Loop Over Items
- Add: Merge B – Enrich with Verified Email → Loop Over Items
- Keep: POST to GDocs → Merge – Outreach (preserve resume generation)
- Keep: All existing email-related nodes and edges

### Node positioning and naming conventions
- Place Set Keys – Jobs directly below/after “Limit Matched Resumes – 313”
- Place Set Keys – Contacts directly below/after “Run an Actor and get dataset”
- Place Merge A between these two columns, visually centered
- Place Merge B to the right of Merge A, feeding into Loop Over Items
- Consistent names: “Set Keys – Jobs”, “Set Keys – Contacts”, “Merge A – Jobs + Contacts”, “Merge B – Enrich with Verified Email”

---

## Testing Strategy
1) Manual execution with 1–3 items
- Inspect Set Keys – Jobs: companyDomain and dedupeKey populated
- Inspect Set Keys – Contacts: contactCompanyDomain and email populated
- Inspect Merge A: items enriched with contact/company info
- Inspect Merge B: items include verified email and remain single records

2) Build Tracking Fields output
- Verify timeStamp, companyName, jobTitle, jobUrl, recepientEmail, dedupeKey, status are all present and sensible

3) Google Sheets verification
- Run through “Email Tracking – Upsert (precheck)”
- In “Tracking” tab, confirm all columns populate
- Re-run same items to confirm upsert by DedupeKey updates existing rows

4) Regression
- Confirm resume generation (POST to GDocs) still returns a file id
- Confirm email sending nodes remain operational (or disabled for test as chosen)

---

## Functionality Preservation
- Do not remove POST to GDocs → Merge – Outreach; resume generation remains intact
- Email sending path and nodes are unchanged; only the precheck source is rerouted to Merge B
- Merge – Outreach can continue serving any other downstream paths if present

---

## Troubleshooting
- Merge A returns fewer items than expected:
  - Check companyDomain/contactCompanyDomain parsing; ensure companyWebsite and organization domains exist
  - Consider fallbacks (e.g., parse from jobUrl if companyWebsite missing)
- Merge B not matching emails:
  - Ensure email is lowercased/trimmed in both streams; verify Neverbounce/verified stream field is "email"
- Still missing fields in Build Tracking Fields:
  - Confirm Merge B feeds Loop Over Items (not Merge – Outreach)
  - Recheck fallback expressions and that items are enriched (look at execution data)
- Need to support multiple contacts per job:
  - Change Merge A Multiple Matches to “Include All Matches” and handle arrays downstream

---

## Edge Cases
- Missing company domain:
  - The domain join won’t match; the job still flows through with partial data; Build Tracking Fields falls back to available fields
- Multiple contacts per company/job:
  - With First Match, only the first contact enriches; switch to “Include All Matches” to expand items if needed, or add a prior filter to choose best contact
- Inconsistent field names from sources:
  - The provided fallbacks cover common variants; extend as needed if sources change

---

## Before/After Data Flow (text diagrams)

Before (position-based):

```
Jobs ─┐
Docs ─┼─> Merge – Outreach (by position) ─> Loop Over Items ─> Build Tracking Fields ─> Sheets
Apollo ─┤
Verified ─┘
```

After (semantic joining):

```
Jobs → Set Keys – Jobs ─┐
                         ├─> Merge A (companyDomain = contactCompanyDomain) ─┐
Apollo → Set Keys – Contacts ────────────────┘                                ├─> Merge B (email = email) ─> Loop Over Items ─> Build Tracking Fields ─> Sheets
Verified Email ONLY ───────────────────────────────────────────────────────────┘

POST to GDocs → Merge – Outreach (kept for resume flow)
```

---

## Validation Checklist (post‑implementation)
- [ ] Set Keys – Jobs adds companyDomain and dedupeKey for all items
- [ ] Set Keys – Contacts adds contactCompanyDomain and normalized email
- [ ] Merge A enriches jobs with contact fields when domains match
- [ ] Merge B enriches with verified email; outputs single enriched items
- [ ] Loop Over Items source is Merge B (not Merge – Outreach)
- [ ] Build Tracking Fields outputs all seven values
- [ ] Google Sheets “Tracking” receives all mapped columns
- [ ] Re-run updates same rows by DedupeKey (no duplicates)
- [ ] Resume generation via POST to GDocs still works
- [ ] Email nodes unaffected (or appropriately disabled for testing)

---

## Context & References
- Target workflow: https://n8n.srv972609.hstgr.cloud/workflow/qRciPpY0DlFJyI8i
- Problem: Only Timestamp and Status populate; Company, Job Title, Job URL, Email, DedupeKey empty
- Goal: Implement semantic joining to ensure all tracking columns receive data from jobs, Apollo contacts, and verified emails
- Constraint: Preserve POST to GDocs resume generation

